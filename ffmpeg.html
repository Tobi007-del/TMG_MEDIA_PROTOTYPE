<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FFmpeg.wasm Caption Extractor</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
        margin: 0;
      }
      video {
        width: 100%;
        max-height: 400px;
        margin-top: 20px;
      }
      pre {
        background: #111;
        color: #0f0;
        padding: 10px;
        max-height: 200px;
        overflow: auto;
      }
    </style>
  </head>
  <body>
    <h2>FFmpeg.wasm Caption Extractor Demo</h2>
    <input title="Choose a video file that has captions built in" type="file" id="videoInput" accept="*" style="margin-bottom: 10px" />
    <video id="video" tmgcontrols tmg--initial-state="false" tmg--initial-mode="theater" tmg--settings--time--previews="true"></video>
    <pre id="log"></pre>
    <!-- <script src="/T007_TOOLS/T007_input_library/T007_input.js"></script>
    <script>
      document.body.insertBefore(createField({ type: "file", id: "videoInput", accept: "*" }), document.getElementById("video"));
    </script> -->
    <script>
      window.TMG_VIDEO_CSS_SRC = "prototype-2/prototype-2-video.css";
      window.TMG_VIDEO_ALT_IMG_SRC = "assets/icons/movie-tape.png";
    </script>
    <script src="prototype-2/prototype-2.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.10.1/dist/ffmpeg.min.js"></script>
    <script>
      const { createFFmpeg, fetchFile } = FFmpeg;

      const ffmpeg = createFFmpeg({ log: true });
      const videoInput = document.getElementById("videoInput");
      const video = document.getElementById("video");
      const log = document.getElementById("log");

      const logger = (msg) => {
        console.log(msg);
        log.textContent += msg + "\n";
      };

      videoInput.addEventListener("change", async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        logger(`üé• Selected file: ${file.name}`);
        video.src = URL.createObjectURL(file);

        if (!ffmpeg.isLoaded()) {
          logger("‚öô Loading ffmpeg.wasm...");
          await ffmpeg.load();
          logger("‚úÖ ffmpeg loaded.");
        }

        const inputName = "input.mp4";
        const outputName = "sub.vtt";

        ffmpeg.FS("writeFile", inputName, await fetchFile(file));

        logger("üõ† Extracting first subtitle stream to .vtt...");
        try {
          await ffmpeg.run("-i", inputName, "-map", "0:s:0?", "-f", "webvtt", outputName);

          const vttData = ffmpeg.FS("readFile", outputName);
          const vttBlob = new Blob([vttData], { type: "text/vtt" });
          const vttURL = URL.createObjectURL(vttBlob);

          const track = document.createElement("track");
          track.kind = "subtitles";
          track.label = "English";
          track.srclang = "en";
          track.src = vttURL;
          track.default = true;
          video.appendChild(track);

          video.tmgPlayer?.Player?.setCaptionsState();
          logger("‚úÖ Subtitles added to video.");
        } catch (err) {
          logger("‚ùå Failed to extract subtitles.");
          logger(err.toString());
        }
      });
    </script>
  </body>
</html>
